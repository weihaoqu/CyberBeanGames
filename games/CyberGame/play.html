<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>so you think you're a hacker?</title>
    <link rel="stylesheet" href="/games/CyberGame/static/style.css">
</head>
<body class="game-active">
    <div class="stars"></div>
    <div class="container">
        <div class="game-hud">
            <div class="hud-item">
                <div class="hud-label">TIMER</div>
                <div id="timer" class="hud-value timer-value">60</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">SCORE</div>
                <div id="score" class="hud-value score-value">0</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">PROGRESS</div>
                <div id="progress" class="hud-value progress-value">1/15</div>
            </div>
        </div>
        <div class="terminal-window game-terminal">
            <div class="terminal-header">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
                <span class="terminal-title">SCHEDULER_DAEMON.exe</span>
            </div>
            <div class="terminal-body">
                <div id="challenge-container" class="challenge-container">
                    <div class="challenge-header">
                        <span class="pulse-dot"></span>
                        <span>TASK ASSIGNED</span>
                        <span class="pulse-dot"></span>
                    </div>
                    <div id="scenario" class="scenario-text"></div>
                    <div id="options-container" class="options-container"></div>
                </div>
                <div id="feedback-container" class="feedback-container hidden">
                    <div id="feedback-result" class="feedback-result"></div>
                    <div id="feedback-explanation" class="feedback-explanation"></div>
                    <button id="next-btn" class="btn-next">NEXT TASK <span class="arrow">&gt;&gt;</span></button>
                </div>
                <div id="loading" class="loading-state hidden">
                    <div class="loading-spinner"></div>
                    <p>PROCESSING TASK<span class="loading-dots">...</span></p>
                </div>
            </div>
        </div>
    </div>
    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">TIME EXPIRED</h2>
            <p class="modal-text">System breach imminent. Redirecting to debriefing...</p>
            <div class="modal-spinner"></div>
        </div>
    </div>
    <script>
        const API = '/api/hack-the-system';
        let gameTimer;
        let timeRemaining = 60;
        let isAnswering = false;

        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const progressEl = document.getElementById('progress');
        const scenarioEl = document.getElementById('scenario');
        const optionsEl = document.getElementById('options-container');
        const challengeEl = document.getElementById('challenge-container');
        const feedbackEl = document.getElementById('feedback-container');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const nextBtn = document.getElementById('next-btn');
        const loadingEl = document.getElementById('loading');
        const gameOverModal = document.getElementById('game-over-modal');

        document.addEventListener('DOMContentLoaded', function() {
            loadChallenge();
            startTimer();
            nextBtn.addEventListener('click', () => loadChallenge());
        });

        function startTimer() {
            gameTimer = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining % 5 === 0) updateServerTime();
                if (timeRemaining <= 0) endGame();
            }, 1000);
        }

        function updateTimerDisplay() {
            timerEl.textContent = timeRemaining;
            timerEl.classList.remove('warning', 'danger');
            if (timeRemaining <= 10) timerEl.classList.add('danger');
            else if (timeRemaining <= 20) timerEl.classList.add('warning');
        }

        function updateServerTime() {
            fetch(API + '/update-time', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ time_remaining: timeRemaining })
            }).catch(e => console.error('Time sync error:', e));
        }

        function loadChallenge() {
            showLoading();
            fetch(API + '/get-challenge', { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.complete) {
                        window.location.href = '/games/CyberGame/result.html';
                    } else {
                        displayChallenge(data);
                    }
                })
                .catch(e => { console.error(e); hideLoading(); });
        }

        function displayChallenge(data) {
            isAnswering = false;
            progressEl.textContent = data.progress.current + '/' + data.progress.total;
            scoreEl.textContent = data.score;
            scenarioEl.textContent = data.challenge.scenario;
            optionsEl.innerHTML = '';
            data.challenge.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-button';
                btn.textContent = opt;
                btn.onclick = () => submitAnswer(i);
                optionsEl.appendChild(btn);
            });
            challengeEl.classList.remove('hidden');
            feedbackEl.classList.add('hidden');
        }

        function submitAnswer(idx) {
            if (isAnswering) return;
            isAnswering = true;
            optionsEl.querySelectorAll('.option-button').forEach(b => b.disabled = true);
            showLoading();
            fetch(API + '/submit-answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ answer: idx })
            })
            .then(r => r.json())
            .then(data => { hideLoading(); displayFeedback(data); })
            .catch(e => { console.error(e); hideLoading(); isAnswering = false; });
        }

        function displayFeedback(data) {
            scoreEl.textContent = data.score;
            timeRemaining = data.time_remaining;
            updateTimerDisplay();
            challengeEl.classList.add('hidden');
            feedbackEl.classList.remove('hidden');
            feedbackEl.classList.remove('correct', 'incorrect');
            feedbackResult.classList.remove('correct', 'incorrect');
            if (data.correct) {
                feedbackEl.classList.add('correct');
                feedbackResult.classList.add('correct');
                feedbackResult.innerHTML = 'CORRECT! +10 POINTS | +5 SECONDS';
            } else {
                feedbackEl.classList.add('incorrect');
                feedbackResult.classList.add('incorrect');
                feedbackResult.innerHTML = 'INCORRECT! -5 POINTS | -3 SECONDS';
            }
            feedbackExplanation.textContent = data.explanation;
            if (data.game_complete) {
                nextBtn.textContent = 'VIEW RESULTS >>';
                nextBtn.onclick = () => { window.location.href = '/games/CyberGame/result.html'; };
            } else {
                nextBtn.textContent = 'NEXT THREAT >>';
                nextBtn.onclick = () => loadChallenge();
            }
        }

        function endGame() {
            clearInterval(gameTimer);
            gameOverModal.classList.remove('hidden');
            setTimeout(() => { window.location.href = '/games/CyberGame/result.html'; }, 2000);
        }

        function showLoading() { loadingEl.classList.remove('hidden'); }
        function hideLoading() { loadingEl.classList.add('hidden'); }
    </script>
</body>
</html>
